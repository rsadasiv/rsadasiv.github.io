<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileStorage.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OOP Core NLP Viewer</a> &gt; <a href="index.source.html" class="el_package">io.outofprintmagazine.web.storage</a> &gt; <span class="el_source">FileStorage.java</span></div><h1>FileStorage.java</h1><pre class="source lang-java linenums">package io.outofprintmagazine.web.storage;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.math.BigDecimal;
import java.math.RoundingMode;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.SortedSet;
import java.util.TreeSet;

import org.apache.commons.io.IOUtils;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.deeplearning4j.models.word2vec.VocabWord;
import org.deeplearning4j.models.word2vec.Word2Vec;
import org.deeplearning4j.models.embeddings.loader.WordVectorSerializer;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;


public class FileStorage implements IStorage {
	
<span class="nc" id="L34">	private static final Logger logger = LogManager.getLogger(FileStorage.class);</span>
	
	@SuppressWarnings(&quot;unused&quot;)
	private Logger getLogger() {
<span class="nc" id="L38">		return logger;</span>
	}
	
<span class="nc" id="L41">	private Properties properties = new Properties();</span>
<span class="nc" id="L42">	private ObjectMapper mapper = new ObjectMapper();</span>
    
    protected ObjectMapper getMapper() {
<span class="nc" id="L45">    	return mapper;</span>
    }
	
<span class="nc" id="L48">	private static Map&lt;Properties, FileStorage&gt; instances = new HashMap&lt;Properties, FileStorage&gt;();</span>
<span class="nc" id="L49">	private Map&lt;String, Map&lt;String, ObjectNode&gt;&gt; corpusDocumentMetadata = new HashMap&lt;String, Map&lt;String, ObjectNode&gt;&gt;();</span>

	private FileStorage() {
<span class="nc" id="L52">		super();</span>
<span class="nc" id="L53">	}</span>
	
	private FileStorage(Properties p) throws IOException {
<span class="nc" id="L56">		this();</span>
<span class="nc" id="L57">		this.properties = p;</span>
<span class="nc" id="L58">		this.initCorpora();</span>
		
<span class="nc" id="L60">	}</span>
	
    public static FileStorage getInstance(Properties p) throws IOException { 
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (instances.get(p) == null) {</span>
<span class="nc" id="L64">        	FileStorage instance = new FileStorage(p);</span>
<span class="nc" id="L65">            instances.put(p, instance);</span>
        }
<span class="nc" id="L67">        return instances.get(p); </span>
    }
    
	protected String getCorpusPath(String corpus) throws IOException {
<span class="nc" id="L71">		String path = (</span>
<span class="nc" id="L72">				properties.getProperty(&quot;fileCorpus_Path&quot;)</span>
<span class="nc" id="L73">				+ System.getProperty(&quot;file.separator&quot;, &quot;/&quot;)	</span>
				+ corpus
		);
<span class="nc" id="L76">		File dir = new File(path);</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">		if (!dir.exists()) dir.mkdirs();</span>
<span class="nc" id="L78">		return path;</span>
		
	}

	protected String getCorpusFilePath(String corpus, String fileName) throws IOException {
<span class="nc" id="L83">		String path = (</span>
<span class="nc" id="L84">				getCorpusPath(corpus) </span>
<span class="nc" id="L85">				+ System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) </span>
				+ fileName
		);
<span class="nc" id="L88">		File file = new File(path);</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">		if (!file.getParentFile().exists()) {</span>
<span class="nc" id="L90">			file.getParentFile().mkdirs();</span>
		}
<span class="nc" id="L92">		return path;</span>
	}
	
	private void initCorpora() throws IOException {
<span class="nc" id="L96">		File[] directories = new File(</span>
<span class="nc" id="L97">				properties.getProperty(&quot;fileCorpus_Path&quot;)).listFiles(File::isDirectory);</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">		for (int i=0;i&lt;directories.length;i++) {</span>
<span class="nc" id="L99">			String corpus = directories[i].getName();</span>
<span class="nc" id="L100">			Map&lt;String, ObjectNode&gt; documentMetadata = new HashMap&lt;String, ObjectNode&gt;();</span>
<span class="nc" id="L101">			corpusDocumentMetadata.put(corpus, documentMetadata);</span>
<span class="nc" id="L102">			initCorpusDocumentMetadata(corpus, documentMetadata);</span>
		}
<span class="nc" id="L104">	}</span>
	
	private void initCorpusDocumentMetadata(String corpus, Map&lt;String, ObjectNode&gt; documentMetadata) throws IOException  {
<span class="nc" id="L107">		File[] documents = new File(</span>
<span class="nc" id="L108">				getCorpusPath(corpus)</span>
<span class="nc" id="L109">				+ System.getProperty(&quot;file.separator&quot;, &quot;/&quot;)	</span>
				+ &quot;Analyze&quot;
<span class="nc" id="L111">		).listFiles(File::isFile);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">		for (int i=0;i&lt;documents.length;i++) {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">			if (documents[i].getName().substring(0, documents[i].getName().lastIndexOf(&quot;.&quot;)).startsWith(&quot;OOP_&quot;)) {</span>
<span class="nc" id="L114">				String document = documents[i].getName().substring(4, documents[i].getName().lastIndexOf(&quot;.&quot;));</span>
<span class="nc" id="L115">				documentMetadata.put(</span>
						document,
<span class="nc" id="L117">						(ObjectNode) getCorpusDocumentJson(</span>
								corpus,
<span class="nc" id="L119">								&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;OOP_&quot; + document + &quot;.json&quot;</span>
<span class="nc" id="L120">						).get(&quot;metadata&quot;).deepCopy()</span>
				);
			}
		}	
<span class="nc" id="L124">	}</span>

	protected InputStream getCorpusDocumentStream(String corpus, String scratchFileName) throws IOException  {
<span class="nc" id="L127">        File f = new File(</span>
<span class="nc" id="L128">        		getCorpusFilePath(</span>
        				corpus, 
        				scratchFileName
        		)
        );
<span class="nc" id="L133">        FileInputStream fin = new FileInputStream(f);</span>
<span class="nc" id="L134">        return fin;</span>
	}
	

	protected String getCorpusDocumentString(String corpus, String scratchFileName) throws IOException {	
<span class="nc" id="L139">	    return IOUtils.toString(</span>
<span class="nc" id="L140">	    		getCorpusDocumentStream(corpus, scratchFileName),</span>
<span class="nc" id="L141">	    		StandardCharsets.UTF_8.name()</span>
	    );
	}
	
	protected JsonNode getCorpusDocumentJson(String corpus, String scratchFileName) throws IOException {
<span class="nc" id="L146">		return getMapper().readTree(</span>
<span class="nc" id="L147">				getCorpusDocumentStream(</span>
						corpus,
						scratchFileName
				)
		);
	}
	
	@Override
	public ArrayNode listCorpora() throws IOException {
<span class="nc" id="L156">		ArrayNode retval = getMapper().createArrayNode();</span>
<span class="nc" id="L157">		SortedSet&lt;String&gt; sortedCorpora = new TreeSet&lt;String&gt;();</span>
<span class="nc" id="L158">		sortedCorpora.addAll(corpusDocumentMetadata.keySet());</span>

<span class="nc bnc" id="L160" title="All 2 branches missed.">		for (String corpus : sortedCorpora) {</span>
<span class="nc" id="L161">			retval.add(corpus);</span>
<span class="nc" id="L162">		}</span>
<span class="nc" id="L163">		return retval;</span>
	}
	
	@Override
    public String getCorpusBatchString(String corpus) throws IOException {
<span class="nc" id="L168">		return getCorpusDocumentString(corpus, corpus+&quot;Batch.json&quot;);		</span>
	}
    
	@Override
    public JsonNode getCorpusBatchJson(String corpus) throws IOException {
<span class="nc" id="L173">		return getCorpusDocumentJson(corpus, corpus+&quot;Batch.json&quot;);		</span>
	}
	
	@Override
    public String getCorpusAggregatesString(String corpus) throws IOException {
<span class="nc" id="L178">		return getCorpusDocumentString(</span>
				corpus, 
<span class="nc" id="L180">				&quot;CorpusAggregate&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;CORPUS_AGGREGATES.json&quot;</span>
		);
	}
    
	@Override
    public JsonNode getCorpusAggregatesJson(String corpus) throws IOException {
<span class="nc" id="L186">		return getCorpusDocumentJson(</span>
				corpus,
<span class="nc" id="L188">				&quot;CorpusAggregate&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;CORPUS_AGGREGATES.json&quot;</span>
		);
	}
	
    public String getCorpusAggregatesIdfString(String corpus) throws IOException {
<span class="nc" id="L193">		return getCorpusDocumentString(</span>
				corpus, 
<span class="nc" id="L195">				&quot;CorpusAggregate&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;CORPUS_AGGREGATES_IDF.json&quot;</span>
		);
	}
    
    public JsonNode getCorpusAggregatesIdfJson(String corpus) throws IOException {
<span class="nc" id="L200">		return getCorpusDocumentJson(</span>
				corpus, 
<span class="nc" id="L202">				&quot;CorpusAggregate&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;CORPUS_AGGREGATES_IDF.json&quot;</span>
		);		
	}
	
	@Override
	public ArrayNode listCorpusDocuments(String corpus) throws IOException {
<span class="nc" id="L208">		ArrayNode retval = getMapper().createArrayNode();</span>
<span class="nc" id="L209">		Map&lt;String, ObjectNode&gt; documentMetadata = corpusDocumentMetadata.get(corpus);</span>
<span class="nc" id="L210">		SortedSet&lt;String&gt; sortedDocuments = new TreeSet&lt;String&gt;();</span>
<span class="nc" id="L211">		sortedDocuments.addAll(documentMetadata.keySet());</span>

<span class="nc bnc" id="L213" title="All 2 branches missed.">		for (String document : sortedDocuments) {</span>
<span class="nc" id="L214">			retval.add(document);</span>
<span class="nc" id="L215">		}		</span>
<span class="nc" id="L216">		return retval;</span>
	}

	@Override
    public String getCorpusDocumentTxtString(String corpus, String document) throws IOException {
<span class="nc" id="L221">    	return getCorpusDocumentString(</span>
    			corpus,	
<span class="nc" id="L223">				&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;TXT_&quot;+document+&quot;.txt&quot;</span>
    	);
    }
    
	@Override
    public String getCorpusDocumentOOPString(String corpus, String document) throws IOException {
<span class="nc" id="L229">    	return getCorpusDocumentString(</span>
    			corpus,
<span class="nc" id="L231">				&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;OOP_&quot;+document+&quot;.json&quot;</span>
    	);
    }
    
	@Override
    public JsonNode getCorpusDocumentOOPJson(String corpus, String document) throws IOException {
<span class="nc" id="L237">    	return getCorpusDocumentJson(</span>
    			corpus,
<span class="nc" id="L239">				&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;OOP_&quot;+document+&quot;.json&quot;</span>
    	);
    }
    
	@Override
    public String getCorpusDocumentAggregatesString(String corpus, String document) throws IOException {
<span class="nc" id="L245">    	return getCorpusDocumentString(</span>
    			corpus, 
<span class="nc" id="L247">				&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;AGGREGATES_&quot;+document+&quot;.json&quot;);</span>
    }
    
	@Override
    public JsonNode getCorpusDocumentAggregatesJson(String corpus, String document) throws IOException {
<span class="nc" id="L252">    	return getCorpusDocumentJson(</span>
    			corpus, 
<span class="nc" id="L254">				&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;AGGREGATES_&quot;+document+&quot;.json&quot;</span>
		);
    }
    

	@Override
	public String getCorpusDocumentPipelineString(String corpus, String document) throws IOException {
<span class="nc" id="L261">    	return getCorpusDocumentString(</span>
    			corpus,
<span class="nc" id="L263">				&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;PIPELINE_&quot;+document+&quot;.json&quot;</span>
    	);
	}

	@Override
	public JsonNode getCorpusDocumentPipelineJson(String corpus, String document) throws IOException {
<span class="nc" id="L269">    	return getCorpusDocumentJson(</span>
				corpus,
<span class="nc" id="L271">				&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;PIPELINE_&quot;+document+&quot;.json&quot;</span>
		);
	}

	@Override
	public String getCorpusDocumentStanfordString(String corpus, String document) throws IOException {
<span class="nc" id="L277">    	return getCorpusDocumentString(</span>
				corpus,
<span class="nc" id="L279">				&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;STANFORD_&quot;+document+&quot;.json&quot;</span>
		);
	}

	@Override
	public JsonNode getCorpusDocumentStanfordJson(String corpus, String document) throws IOException {
<span class="nc" id="L285">    	return getCorpusDocumentJson(</span>
				corpus,
<span class="nc" id="L287">				&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;STANFORD_&quot;+document+&quot;.json&quot;</span>
		);
	}
	
	@Override
    public ObjectNode getCorpusDocumentOOPMetadata(String corpus, String document) throws IOException {
<span class="nc" id="L293">		return corpusDocumentMetadata.get(corpus).get(document);</span>
	}
	
	@Override
    public String getCorpusDocumentTfidfString(String corpus, String document) throws IOException {
<span class="nc" id="L298">    	return getCorpusDocumentString(</span>
    			corpus, 
<span class="nc" id="L300">				&quot;CoreNLPTfidf&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;TfidfScores_&quot;+document+&quot;.json&quot;</span>
		);
	}
    
	@Override
    public JsonNode getCorpusDocumentTfidfJson(String corpus, String document) throws IOException {
<span class="nc" id="L306">    	return getCorpusDocumentJson(</span>
    			corpus, 
<span class="nc" id="L308">				&quot;CoreNLPTfidf&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;TfidfScores_&quot;+document+&quot;.json&quot;</span>
		);
	}

	@Override
    public String getCorpusDocumentZString(String corpus, String document) throws IOException {
<span class="nc" id="L314">    	return getCorpusDocumentString(</span>
    			corpus, 
<span class="nc" id="L316">				&quot;CoreNLPZ&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;ZScores_&quot;+document+&quot;.json&quot;</span>
		);
	}
	
	@Override
    public JsonNode getCorpusDocumentZJson(String corpus, String document) throws IOException {
<span class="nc" id="L322">    	return getCorpusDocumentJson(</span>
    			corpus, 
<span class="nc" id="L324">				&quot;CoreNLPZ&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;ZScores_&quot;+document+&quot;.json&quot;);</span>
	}
	
	@Override
    public String getCorpusAggregatesMBString(String corpus) throws IOException {
<span class="nc" id="L329">    	return getCorpusDocumentString(</span>
    			corpus,
<span class="nc" id="L331">				&quot;CorpusAggregate&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;CORPUS_AGGREGATES_MB.json&quot;</span>
    	);
    }
    
	@Override
    public JsonNode getCorpusAggregatesMBJson(String corpus) throws IOException {
<span class="nc" id="L337">    	return getCorpusDocumentJson(</span>
    			corpus,
<span class="nc" id="L339">				&quot;CorpusAggregate&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;CORPUS_AGGREGATES_MB.json&quot;</span>
    	);
    }
	
	@Override
    public JsonNode getCorpusDocumentTopicModelLemma(String corpus, String document, String lemma) throws IOException {
<span class="nc" id="L345">		ArrayNode retval = getMapper().createArrayNode();</span>
		try {
<span class="nc" id="L347">			Word2Vec vec = WordVectorSerializer.readWord2VecModel(</span>
<span class="nc" id="L348">					getCorpusFilePath(corpus, &quot;Word2Vec/Lemmas_&quot;+document+&quot;.word2vec&quot;)</span>
			);
			
<span class="nc bnc" id="L351" title="All 2 branches missed.">			for (String similarWord : vec.wordsNearest(lemma, 25)) {</span>
<span class="nc" id="L352">				double cosSim = vec.similarity(lemma, similarWord);</span>
<span class="nc" id="L353">				ObjectNode tidy = getMapper().createObjectNode();</span>
<span class="nc" id="L354">				tidy.put(&quot;name&quot;, similarWord);</span>
<span class="nc" id="L355">				tidy.put(&quot;value&quot;, cosSim);</span>
<span class="nc" id="L356">				retval.add(tidy);</span>
<span class="nc" id="L357">			}</span>
		}
<span class="nc" id="L359">		catch (Exception e) {</span>
<span class="nc" id="L360">			e.printStackTrace();</span>
<span class="nc" id="L361">		}</span>
		
<span class="nc" id="L363">		return retval;</span>
    }
    
    
	@Override
    public JsonNode getCorpusDocumentTopicModelLemmaPOS(String corpus, String document, String lemma) throws IOException {
<span class="nc" id="L369">		ObjectNode retval = getMapper().createObjectNode();</span>
		try {
<span class="nc" id="L371">			Word2Vec vec = WordVectorSerializer.readWord2VecModel(</span>
<span class="nc" id="L372">					getCorpusFilePath(corpus, &quot;Word2Vec/Lemmas_POS_&quot;+document+&quot;.word2vec&quot;)</span>
			);
<span class="nc bnc" id="L374" title="All 2 branches missed.">			for (VocabWord vocabWord : vec.getVocab().vocabWords()) {</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">				if (vocabWord.getWord().startsWith(lemma)) {</span>
<span class="nc" id="L376">					ArrayNode similarity = retval.putArray(vocabWord.getWord());</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">					for (String similarWord : vec.wordsNearest(vocabWord.getWord(), 25)) {</span>
<span class="nc" id="L378">						double cosSim = vec.similarity(vocabWord.getWord(), similarWord);</span>
<span class="nc" id="L379">						ObjectNode tidy = getMapper().createObjectNode();</span>
<span class="nc" id="L380">						tidy.put(&quot;name&quot;, similarWord);</span>
<span class="nc" id="L381">						tidy.put(&quot;value&quot;, cosSim);</span>
<span class="nc" id="L382">						similarity.add(tidy);</span>
<span class="nc" id="L383">					}</span>
				}
<span class="nc" id="L385">			}</span>
		}
<span class="nc" id="L387">		catch (Exception e) {</span>
<span class="nc" id="L388">			e.printStackTrace();</span>
<span class="nc" id="L389">		}</span>
<span class="nc" id="L390">		return retval;</span>
    }
	
	private void setAttributeAvg(ObjectNode retval, List&lt;BigDecimal&gt; scores, String annotationName) {
<span class="nc bnc" id="L394" title="All 2 branches missed.">		if (scores.size() &gt; 0) {</span>
<span class="nc" id="L395">			BigDecimal total = new BigDecimal(0);</span>
<span class="nc" id="L396">			BigDecimal count = new BigDecimal(scores.size());</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">			for (BigDecimal score : scores) {</span>
<span class="nc" id="L398">				total = total.add(score);</span>
<span class="nc" id="L399">			}</span>
<span class="nc" id="L400">			((ObjectNode)retval.get(&quot;attributes&quot;)).put(</span>
					annotationName, 
<span class="nc" id="L402">					total.divide(count, 10, RoundingMode.HALF_DOWN)</span>
			);
		}
<span class="nc" id="L405">	}</span>
	
	private void setAttributeListBigDecimal(ObjectNode retval, List&lt;BigDecimal&gt; scores, String annotationName) {
<span class="nc bnc" id="L408" title="All 2 branches missed.">		if (scores.size() &gt; 0) {</span>
<span class="nc" id="L409">			ArrayNode list = ((ObjectNode)retval.get(&quot;lists&quot;)).putArray(annotationName);</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">			for (BigDecimal score : scores) {</span>
<span class="nc" id="L411">				list.add(score);</span>
<span class="nc" id="L412">			}</span>
		}
<span class="nc" id="L414">	}</span>
	
	private void setAttributeListString(ObjectNode retval, List&lt;String&gt; scores, String annotationName) {
<span class="nc bnc" id="L417" title="All 2 branches missed.">		if (scores.size() &gt; 0) {</span>
<span class="nc" id="L418">			ArrayNode list = ((ObjectNode)retval.get(&quot;lists&quot;)).putArray(annotationName);</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">			for (String score : scores) {</span>
<span class="nc" id="L420">				list.add(score);</span>
<span class="nc" id="L421">			}</span>
		}
<span class="nc" id="L423">	}</span>
	
	private void setAttributeSubAnnotation(ObjectNode retval, ObjectNode tokenNode, String subAnnotationName) {
<span class="nc" id="L426">		ObjectNode annotationNode = getMapper().createObjectNode();</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">		if (tokenNode.has(subAnnotationName)) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">			if (retval.get(&quot;attributes&quot;).has(subAnnotationName)) {</span>
<span class="nc" id="L429">				annotationNode = (ObjectNode) retval.get(&quot;attributes&quot;).get(subAnnotationName);</span>
			}
			else {
<span class="nc" id="L432">				annotationNode = ((ObjectNode)retval.get(&quot;attributes&quot;)).putObject(subAnnotationName);</span>
			}
<span class="nc" id="L434">			BigDecimal val = new BigDecimal(1);</span>
<span class="nc bnc" id="L435" title="All 2 branches missed.">			if (annotationNode.has(tokenNode.get(subAnnotationName).asText())) {</span>
<span class="nc" id="L436">				val = new BigDecimal(annotationNode.get(tokenNode.get(subAnnotationName).asText()).asText()).add(val);</span>
			}
<span class="nc" id="L438">			annotationNode.put(tokenNode.get(subAnnotationName).asText(), val);</span>
		}
<span class="nc" id="L440">	}</span>
	
	private void setAttributeAnnotation(ObjectNode retval, ObjectNode tokenNode, String annotation) {
<span class="nc" id="L443">		ObjectNode annotationNode = getMapper().createObjectNode();</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">		if (tokenNode.has(annotation)) {</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">			if (tokenNode.get(annotation).isObject()) {</span>
<span class="nc" id="L446">				Iterator&lt;String&gt; fieldNameIter = ((ObjectNode)tokenNode.get(annotation)).fieldNames();</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">				while (fieldNameIter.hasNext()) {</span>
<span class="nc" id="L448">					String subAnnotationName = fieldNameIter.next();</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">					if (tokenNode.get(annotation).has(subAnnotationName)) {</span>
<span class="nc" id="L450">						BigDecimal val = new BigDecimal(tokenNode.get(annotation).get(subAnnotationName).asText());</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">						if (retval.get(&quot;attributes&quot;).has(annotation)) {</span>
<span class="nc" id="L452">							annotationNode = (ObjectNode) retval.get(&quot;attributes&quot;).get(annotation);</span>
						}
						else {
<span class="nc" id="L455">							annotationNode = ((ObjectNode)retval.get(&quot;attributes&quot;)).putObject(annotation);</span>
						}
<span class="nc bnc" id="L457" title="All 2 branches missed.">						if (annotationNode.has(subAnnotationName)) {</span>
<span class="nc" id="L458">							val = new BigDecimal(annotationNode.get(subAnnotationName).asText()).add(val);</span>
						}
<span class="nc" id="L460">						annotationNode.put(subAnnotationName, val);</span>
					}
<span class="nc" id="L462">				}</span>
<span class="nc" id="L463">			}</span>
			else {
<span class="nc" id="L465">				System.out.println(annotation);</span>
			}
		}
<span class="nc" id="L468">	}</span>
	
	private void setAttributeList(ObjectNode retval, ObjectNode tokenNode, String annotation) {
<span class="nc" id="L471">		ArrayNode annotationNode = getMapper().createArrayNode();</span>

<span class="nc bnc" id="L473" title="All 2 branches missed.">		if (tokenNode.has(annotation)) {</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">			if (retval.get(&quot;attributes&quot;).has(annotation)) {</span>
<span class="nc" id="L475">				annotationNode = (ArrayNode) retval.get(&quot;attributes&quot;).get(annotation);</span>
			}
			else {
<span class="nc" id="L478">				annotationNode = ((ObjectNode)retval.get(&quot;attributes&quot;)).putArray(annotation);</span>
			}
<span class="nc" id="L480">			boolean annotationInList = false;</span>
<span class="nc" id="L481">			Iterator&lt;JsonNode&gt; attributeListIter = annotationNode.iterator();</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">			while (attributeListIter.hasNext()) {</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">				if (attributeListIter.next().asText().equals(tokenNode.get(annotation).asText())) {</span>
<span class="nc" id="L484">					annotationInList = true;</span>
<span class="nc" id="L485">					break;</span>
				}
			}
<span class="nc bnc" id="L488" title="All 2 branches missed.">			if (!annotationInList) {</span>
<span class="nc" id="L489">				annotationNode.add(tokenNode.get(annotation).asText());</span>
			}
		}
<span class="nc" id="L492">	}</span>
	
	@Override
    public JsonNode getCorpusDocumentLexiconLemma(String corpus, String document, String lemma) throws IOException {
<span class="nc" id="L496">		ObjectNode retval = null;</span>
<span class="nc" id="L497">		List&lt;BigDecimal&gt; oopSyllableCountAnnotations = new ArrayList&lt;BigDecimal&gt;();</span>
<span class="nc" id="L498">		List&lt;BigDecimal&gt; vaderSentimentAnnotations = new ArrayList&lt;BigDecimal&gt;();</span>
<span class="nc" id="L499">		List&lt;BigDecimal&gt; coreNlpSentimentAnnotations = new ArrayList&lt;BigDecimal&gt;();</span>
<span class="nc" id="L500">		List&lt;BigDecimal&gt; oopWordCountAnnotations = new ArrayList&lt;BigDecimal&gt;();</span>
<span class="nc" id="L501">		List&lt;BigDecimal&gt; oopFleschKinkaidAnnotations = new ArrayList&lt;BigDecimal&gt;();</span>
<span class="nc" id="L502">		List&lt;BigDecimal&gt; paragraphIndexAnnotations = new ArrayList&lt;BigDecimal&gt;();</span>
<span class="nc" id="L503">		List&lt;BigDecimal&gt; sentenceIndexAnnotations = new ArrayList&lt;BigDecimal&gt;();</span>
<span class="nc" id="L504">		List&lt;String&gt; sentenceTextAnnotations = new ArrayList&lt;String&gt;();	</span>
<span class="nc" id="L505">		JsonNode scores = getCorpusDocumentOOPJson(corpus, document);</span>
<span class="nc" id="L506">		Iterator&lt;JsonNode&gt; sentenceIterator = scores.get(&quot;sentences&quot;).elements();</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">		for (int sentenceIdx=0;sentenceIterator.hasNext();sentenceIdx++) {</span>
<span class="nc" id="L508">			JsonNode sentenceNode = sentenceIterator.next();</span>
<span class="nc" id="L509">			Iterator&lt;JsonNode&gt; tokenIterator = sentenceNode.get(&quot;tokens&quot;).elements();</span>
<span class="nc" id="L510">			boolean lemmaInSentence = false;</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">			while (tokenIterator.hasNext()) {</span>
<span class="nc" id="L512">				ObjectNode tokenNode = (ObjectNode) tokenIterator.next();</span>
<span class="nc" id="L513">				ObjectNode tokensAnnotation = (ObjectNode) tokenNode.get(&quot;TokensAnnotation&quot;);</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">				if (tokensAnnotation.get(&quot;lemma&quot;).asText().equals(lemma)) {</span>
<span class="nc" id="L515">					lemmaInSentence = true;</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">					if (retval == null) {</span>
<span class="nc" id="L517">						retval = getMapper().createObjectNode();</span>
<span class="nc" id="L518">						retval.put(&quot;canonicalName&quot;, lemma);</span>
<span class="nc" id="L519">						retval.put(&quot;firstAppearance&quot;, sentenceIdx);</span>
<span class="nc" id="L520">						retval.put(&quot;lastAppearance&quot;, sentenceIdx);</span>
<span class="nc" id="L521">						retval.put(&quot;importance&quot;, new BigDecimal(0));</span>
<span class="nc" id="L522">						retval.putObject(&quot;attributes&quot;);</span>
<span class="nc" id="L523">						retval.putObject(&quot;lists&quot;);</span>
					}
<span class="nc" id="L525">					retval.put(&quot;lastAppearance&quot;, sentenceIdx);</span>
<span class="nc" id="L526">					retval.put(&quot;importance&quot;, retval.get(&quot;importance&quot;).asInt()+1);</span>
					//attributes
<span class="nc" id="L528">					setAttributeSubAnnotation(retval, tokensAnnotation, &quot;word&quot;);</span>
<span class="nc" id="L529">					setAttributeSubAnnotation(retval, tokensAnnotation, &quot;pos&quot;);</span>
<span class="nc" id="L530">					setAttributeSubAnnotation(retval, tokensAnnotation, &quot;ner&quot;);</span>
					
<span class="nc" id="L532">					setAttributeAnnotation(retval, tokenNode, &quot;CoreNlpGenderAnnotation&quot;);</span>
<span class="nc" id="L533">					setAttributeAnnotation(retval, tokenNode, &quot;OOPAmericanizeAnnotation&quot;);</span>
<span class="nc" id="L534">					setAttributeAnnotation(retval, tokenNode, &quot;OOPAngliciseAnnotation&quot;);</span>
<span class="nc" id="L535">					setAttributeAnnotation(retval, tokenNode, &quot;OOPBiberAnnotation&quot;);</span>
<span class="nc" id="L536">					setAttributeAnnotation(retval, tokenNode, &quot;OOPBiberDimensionsAnnotation&quot;);</span>
<span class="nc" id="L537">					setAttributeAnnotation(retval, tokenNode, &quot;OOPColorsAnnotation&quot;);</span>
<span class="nc" id="L538">					setAttributeAnnotation(retval, tokenNode, &quot;OOPCommonWordsAnnotation&quot;);</span>
<span class="nc" id="L539">					setAttributeAnnotation(retval, tokenNode, &quot;OOPFlavorsAnnotation&quot;);</span>
<span class="nc" id="L540">					setAttributeAnnotation(retval, tokenNode, &quot;OOPFunctionWordsAnnotation&quot;);</span>
<span class="nc" id="L541">					setAttributeAnnotation(retval, tokenNode, &quot;OOPGenderAnnotation&quot;);</span>
<span class="nc" id="L542">					setAttributeAnnotation(retval, tokenNode, &quot;OOPNonAffirmativeAnnotation&quot;);</span>
<span class="nc" id="L543">					setAttributeAnnotation(retval, tokenNode, &quot;OOPNounGroupsAnnotation&quot;);</span>
<span class="nc" id="L544">					setAttributeAnnotation(retval, tokenNode, &quot;OOPNounNypernymsAnnotation&quot;);</span>
<span class="nc" id="L545">					setAttributeAnnotation(retval, tokenNode, &quot;OOPPointlessAdjectivesAnnotation&quot;);</span>
<span class="nc" id="L546">					setAttributeAnnotation(retval, tokenNode, &quot;OOPPointlessAdverbsAnnotation&quot;);</span>
<span class="nc" id="L547">					setAttributeAnnotation(retval, tokenNode, &quot;OOPSVOAnnotation&quot;);</span>
<span class="nc bnc" id="L548" title="All 2 branches missed.">					if (tokenNode.has(&quot;OOPSyllableCountAnnotation&quot;)) {</span>
<span class="nc" id="L549">						oopSyllableCountAnnotations.add(new BigDecimal(tokenNode.get(&quot;OOPSyllableCountAnnotation&quot;).asText()));</span>
					}
<span class="nc" id="L551">					setAttributeAnnotation(retval, tokenNode, &quot;OOPTemporalNGramsAnnotation&quot;);</span>
<span class="nc" id="L552">					setAttributeAnnotation(retval, tokenNode, &quot;OOPUncommonWordsAnnotation&quot;);</span>
<span class="nc" id="L553">					setAttributeAnnotation(retval, tokenNode, &quot;OOPVerbGroupsAnnotation&quot;);</span>
<span class="nc" id="L554">					setAttributeAnnotation(retval, tokenNode, &quot;OOPVerbHypernymsAnnotation&quot;);</span>
<span class="nc" id="L555">					setAttributeAnnotation(retval, tokenNode, &quot;OOPVerbnetGroupsAnnotation&quot;);</span>
<span class="nc" id="L556">					setAttributeAnnotation(retval, tokenNode, &quot;OOPWordlessWordsAnnotation&quot;);</span>
					
<span class="nc" id="L558">					setAttributeList(retval, tokenNode, &quot;OOPWikipediaGlossAnnotation&quot;);</span>
<span class="nc" id="L559">					setAttributeList(retval, tokenNode, &quot;OOPWordnetGlossAnnotation&quot;);</span>
				}	
<span class="nc" id="L561">			}</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">			if (lemmaInSentence) {</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">				if (sentenceNode.has(&quot;VaderSentimentAnnotation&quot;)) {</span>
<span class="nc" id="L564">					vaderSentimentAnnotations.add(new BigDecimal(sentenceNode.get(&quot;VaderSentimentAnnotation&quot;).asText()));</span>
				}
<span class="nc bnc" id="L566" title="All 2 branches missed.">				if (sentenceNode.has(&quot;CoreNlpSentimentAnnotation&quot;)) {</span>
<span class="nc" id="L567">					coreNlpSentimentAnnotations.add(new BigDecimal(sentenceNode.get(&quot;CoreNlpSentimentAnnotation&quot;).asText()));</span>
				}
<span class="nc bnc" id="L569" title="All 2 branches missed.">				if (sentenceNode.has(&quot;OOPWordCountAnnotation&quot;)) {</span>
<span class="nc" id="L570">					oopWordCountAnnotations.add(new BigDecimal(sentenceNode.get(&quot;OOPWordCountAnnotation&quot;).asText()));</span>
				}
<span class="nc bnc" id="L572" title="All 2 branches missed.">				if (sentenceNode.has(&quot;OOPFleschKinkaidAnnotation&quot;)) {</span>
<span class="nc" id="L573">					oopFleschKinkaidAnnotations.add(new BigDecimal(sentenceNode.get(&quot;OOPFleschKinkaidAnnotation&quot;).asText()));</span>
				}
<span class="nc bnc" id="L575" title="All 2 branches missed.">				if (sentenceNode.has(&quot;text&quot;)) {</span>
<span class="nc" id="L576">					sentenceTextAnnotations.add(sentenceNode.get(&quot;text&quot;).asText());</span>
				}
<span class="nc bnc" id="L578" title="All 2 branches missed.">				if (sentenceNode.has(&quot;SentenceIndexAnnotation&quot;)) {</span>
<span class="nc" id="L579">					sentenceIndexAnnotations.add(new BigDecimal(sentenceNode.get(&quot;SentenceIndexAnnotation&quot;).asText()));</span>
				}
<span class="nc bnc" id="L581" title="All 2 branches missed.">				if (sentenceNode.has(&quot;ParagraphIndexAnnotation&quot;)) {</span>
<span class="nc" id="L582">					paragraphIndexAnnotations.add(new BigDecimal(sentenceNode.get(&quot;ParagraphIndexAnnotation&quot;).asText()));</span>
				}				
<span class="nc bnc" id="L584" title="All 2 branches missed.">				if (sentenceNode.has(&quot;OOPPunctuationMarkAnnotation&quot;)) {</span>
<span class="nc" id="L585">					setAttributeAnnotation(retval, (ObjectNode)sentenceNode, &quot;OOPPunctuationMarkAnnotation&quot;);</span>
				}
			}
		}
<span class="nc" id="L589">		setAttributeAvg(retval, oopSyllableCountAnnotations, &quot;OOPSyllableCountAnnotation&quot;);</span>
<span class="nc" id="L590">		setAttributeAvg(retval, vaderSentimentAnnotations, &quot;VaderSentimentAnnotation&quot;);</span>
<span class="nc" id="L591">		setAttributeAvg(retval, coreNlpSentimentAnnotations, &quot;CoreNlpSentimentAnnotation&quot;);</span>
<span class="nc" id="L592">		setAttributeAvg(retval, oopWordCountAnnotations, &quot;OOPWordCountAnnotation&quot;);</span>
<span class="nc" id="L593">		setAttributeAvg(retval, oopFleschKinkaidAnnotations, &quot;OOPFleschKinkaidAnnotation&quot;);</span>
<span class="nc" id="L594">		setAttributeListBigDecimal(retval, paragraphIndexAnnotations, &quot;ParagraphIndexAnnotation&quot;);</span>
<span class="nc" id="L595">		setAttributeListBigDecimal(retval, sentenceIndexAnnotations, &quot;SentenceIndexAnnotation&quot;);</span>
<span class="nc" id="L596">		setAttributeListString(retval, sentenceTextAnnotations, &quot;SentenceTextAnnotation&quot;);		</span>
		
<span class="nc" id="L598">		return retval;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>