<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FileStorage.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OOP Core NLP Viewer</a> &gt; <a href="index.source.html" class="el_package">io.outofprintmagazine.web.storage</a> &gt; <span class="el_source">FileStorage.java</span></div><h1>FileStorage.java</h1><pre class="source lang-java linenums">package io.outofprintmagazine.web.storage;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.math.BigDecimal;
import java.math.RoundingMode;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.SortedSet;
import java.util.TreeSet;

import org.apache.commons.io.IOUtils;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.deeplearning4j.models.word2vec.VocabWord;
import org.deeplearning4j.models.word2vec.Word2Vec;
import org.deeplearning4j.models.embeddings.loader.WordVectorSerializer;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;


public class FileStorage implements IStorage {
	
<span class="nc" id="L34">	private static final Logger logger = LogManager.getLogger(FileStorage.class);</span>
	
	@SuppressWarnings(&quot;unused&quot;)
	private Logger getLogger() {
<span class="nc" id="L38">		return logger;</span>
	}
	
<span class="nc" id="L41">	private Properties properties = new Properties();</span>
<span class="nc" id="L42">	private ObjectMapper mapper = new ObjectMapper();</span>
    
    protected ObjectMapper getMapper() {
<span class="nc" id="L45">    	return mapper;</span>
    }
	
<span class="nc" id="L48">	private static Map&lt;Properties, FileStorage&gt; instances = new HashMap&lt;Properties, FileStorage&gt;();</span>
<span class="nc" id="L49">	private Map&lt;String, Map&lt;String, ObjectNode&gt;&gt; corpusDocumentMetadata = new HashMap&lt;String, Map&lt;String, ObjectNode&gt;&gt;();</span>

	private FileStorage() {
<span class="nc" id="L52">		super();</span>
<span class="nc" id="L53">	}</span>
	
	private FileStorage(Properties p) throws IOException {
<span class="nc" id="L56">		this();</span>
<span class="nc" id="L57">		this.properties = p;</span>
<span class="nc" id="L58">		this.initCorpora();</span>
		
<span class="nc" id="L60">	}</span>
	
    public static FileStorage getInstance(Properties p) throws IOException { 
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (instances.get(p) == null) {</span>
<span class="nc" id="L64">        	FileStorage instance = new FileStorage(p);</span>
<span class="nc" id="L65">            instances.put(p, instance);</span>
        }
<span class="nc" id="L67">        return instances.get(p); </span>
    }
    
	protected String getCorpusPath(String corpus) throws IOException {
<span class="nc" id="L71">		String path = (</span>
<span class="nc" id="L72">				properties.getProperty(&quot;fileCorpus_Path&quot;)</span>
<span class="nc" id="L73">				+ System.getProperty(&quot;file.separator&quot;, &quot;/&quot;)	</span>
				+ corpus
		);
<span class="nc" id="L76">		File dir = new File(path);</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">		if (!dir.exists()) dir.mkdirs();</span>
<span class="nc" id="L78">		return path;</span>
		
	}

	protected String getCorpusFilePath(String corpus, String fileName) throws IOException {
<span class="nc" id="L83">		String path = (</span>
<span class="nc" id="L84">				getCorpusPath(corpus) </span>
<span class="nc" id="L85">				+ System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) </span>
				+ fileName
		);
<span class="nc" id="L88">		File file = new File(path);</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">		if (!file.getParentFile().exists()) {</span>
<span class="nc" id="L90">			file.getParentFile().mkdirs();</span>
		}
<span class="nc" id="L92">		return path;</span>
	}
	
	private void initCorpora() throws IOException {
<span class="nc" id="L96">		File[] directories = new File(</span>
<span class="nc" id="L97">				properties.getProperty(&quot;fileCorpus_Path&quot;)).listFiles(File::isDirectory);</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">		for (int i=0;i&lt;directories.length;i++) {</span>
<span class="nc" id="L99">			String corpus = directories[i].getName();</span>
<span class="nc" id="L100">			Map&lt;String, ObjectNode&gt; documentMetadata = new HashMap&lt;String, ObjectNode&gt;();</span>
<span class="nc" id="L101">			corpusDocumentMetadata.put(corpus, documentMetadata);</span>
<span class="nc" id="L102">			initCorpusDocumentMetadata(corpus, documentMetadata);</span>
		}
<span class="nc" id="L104">	}</span>
	
	private void initCorpusDocumentMetadata(String corpus, Map&lt;String, ObjectNode&gt; documentMetadata) throws IOException  {
<span class="nc" id="L107">		File[] documents = new File(</span>
<span class="nc" id="L108">				getCorpusPath(corpus)</span>
<span class="nc" id="L109">				+ System.getProperty(&quot;file.separator&quot;, &quot;/&quot;)	</span>
				+ &quot;Analyze&quot;
<span class="nc" id="L111">		).listFiles(File::isFile);</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">		for (int i=0;i&lt;documents.length;i++) {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">			if (documents[i].getName().substring(0, documents[i].getName().lastIndexOf(&quot;.&quot;)).startsWith(&quot;OOP_&quot;)) {</span>
<span class="nc" id="L114">				String document = documents[i].getName().substring(4, documents[i].getName().lastIndexOf(&quot;.&quot;));</span>
<span class="nc" id="L115">				JsonNode stats = getCorpusDocumentJson(</span>
						corpus,
<span class="nc" id="L117">						&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;OOP_&quot; + document + &quot;.json&quot;</span>
				);
<span class="nc bnc" id="L119" title="All 6 branches missed.">				if (stats != null &amp;&amp; !stats.isNull() &amp;&amp; stats.hasNonNull(&quot;metadata&quot;)) {</span>
<span class="nc" id="L120">					documentMetadata.put(</span>
							document,
<span class="nc" id="L122">							(ObjectNode) stats.get(&quot;metadata&quot;).deepCopy()</span>
					);
				}
			}
		}	
<span class="nc" id="L127">	}</span>

	protected InputStream getCorpusDocumentStream(String corpus, String scratchFileName) throws IOException  {
<span class="nc" id="L130">        File f = new File(</span>
<span class="nc" id="L131">        		getCorpusFilePath(</span>
        				corpus, 
        				scratchFileName
        		)
        );
<span class="nc" id="L136">        FileInputStream fin = new FileInputStream(f);</span>
<span class="nc" id="L137">        return fin;</span>
	}
	

	protected String getCorpusDocumentString(String corpus, String scratchFileName) throws IOException {	
<span class="nc" id="L142">	    return IOUtils.toString(</span>
<span class="nc" id="L143">	    		getCorpusDocumentStream(corpus, scratchFileName),</span>
<span class="nc" id="L144">	    		StandardCharsets.UTF_8.name()</span>
	    );
	}
	
	protected JsonNode getCorpusDocumentJson(String corpus, String scratchFileName) throws IOException {
<span class="nc" id="L149">		return getMapper().readTree(</span>
<span class="nc" id="L150">				getCorpusDocumentStream(</span>
						corpus,
						scratchFileName
				)
		);
	}
	
	@Override
	public ArrayNode listCorpora() throws IOException {
<span class="nc" id="L159">		ArrayNode retval = getMapper().createArrayNode();</span>
<span class="nc" id="L160">		SortedSet&lt;String&gt; sortedCorpora = new TreeSet&lt;String&gt;();</span>
<span class="nc" id="L161">		sortedCorpora.addAll(corpusDocumentMetadata.keySet());</span>

<span class="nc bnc" id="L163" title="All 2 branches missed.">		for (String corpus : sortedCorpora) {</span>
<span class="nc" id="L164">			retval.add(corpus);</span>
<span class="nc" id="L165">		}</span>
<span class="nc" id="L166">		return retval;</span>
	}
	
	@Override
    public String getCorpusBatchString(String corpus) throws IOException {
<span class="nc" id="L171">		return getCorpusDocumentString(corpus, corpus+&quot;Batch.json&quot;);		</span>
	}
    
	@Override
    public JsonNode getCorpusBatchJson(String corpus) throws IOException {
<span class="nc" id="L176">		return getCorpusDocumentJson(corpus, corpus+&quot;Batch.json&quot;);		</span>
	}
	
	@Override
    public String getCorpusAggregatesString(String corpus) throws IOException {
<span class="nc" id="L181">		return getCorpusDocumentString(</span>
				corpus, 
<span class="nc" id="L183">				&quot;CorpusAggregate&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;CORPUS_AGGREGATES.json&quot;</span>
		);
	}
    
	@Override
    public JsonNode getCorpusAggregatesJson(String corpus) throws IOException {
<span class="nc" id="L189">		return getCorpusDocumentJson(</span>
				corpus,
<span class="nc" id="L191">				&quot;CorpusAggregate&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;CORPUS_AGGREGATES.json&quot;</span>
		);
	}
	
    public String getCorpusAggregatesIdfString(String corpus) throws IOException {
<span class="nc" id="L196">		return getCorpusDocumentString(</span>
				corpus, 
<span class="nc" id="L198">				&quot;CorpusAggregate&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;CORPUS_AGGREGATES_IDF.json&quot;</span>
		);
	}
    
    public JsonNode getCorpusAggregatesIdfJson(String corpus) throws IOException {
<span class="nc" id="L203">		return getCorpusDocumentJson(</span>
				corpus, 
<span class="nc" id="L205">				&quot;CorpusAggregate&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;CORPUS_AGGREGATES_IDF.json&quot;</span>
		);		
	}
	
	@Override
	public ArrayNode listCorpusDocuments(String corpus) throws IOException {
<span class="nc" id="L211">		ArrayNode retval = getMapper().createArrayNode();</span>
<span class="nc" id="L212">		Map&lt;String, ObjectNode&gt; documentMetadata = corpusDocumentMetadata.get(corpus);</span>
<span class="nc" id="L213">		SortedSet&lt;String&gt; sortedDocuments = new TreeSet&lt;String&gt;();</span>
<span class="nc" id="L214">		sortedDocuments.addAll(documentMetadata.keySet());</span>

<span class="nc bnc" id="L216" title="All 2 branches missed.">		for (String document : sortedDocuments) {</span>
<span class="nc" id="L217">			retval.add(document);</span>
<span class="nc" id="L218">		}		</span>
<span class="nc" id="L219">		return retval;</span>
	}

	@Override
    public String getCorpusDocumentTxtString(String corpus, String document) throws IOException {
<span class="nc" id="L224">    	return getCorpusDocumentString(</span>
    			corpus,	
<span class="nc" id="L226">				&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;TXT_&quot;+document+&quot;.txt&quot;</span>
    	);
    }
    
	@Override
    public String getCorpusDocumentOOPString(String corpus, String document) throws IOException {
<span class="nc" id="L232">    	return getCorpusDocumentString(</span>
    			corpus,
<span class="nc" id="L234">				&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;OOP_&quot;+document+&quot;.json&quot;</span>
    	);
    }
    
	@Override
    public JsonNode getCorpusDocumentOOPJson(String corpus, String document) throws IOException {
<span class="nc" id="L240">    	return getCorpusDocumentJson(</span>
    			corpus,
<span class="nc" id="L242">				&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;OOP_&quot;+document+&quot;.json&quot;</span>
    	);
    }
    
	@Override
    public String getCorpusDocumentAggregatesString(String corpus, String document) throws IOException {
<span class="nc" id="L248">    	return getCorpusDocumentString(</span>
    			corpus, 
<span class="nc" id="L250">				&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;AGGREGATES_&quot;+document+&quot;.json&quot;);</span>
    }
    
	@Override
    public JsonNode getCorpusDocumentAggregatesJson(String corpus, String document) throws IOException {
<span class="nc" id="L255">    	return getCorpusDocumentJson(</span>
    			corpus, 
<span class="nc" id="L257">				&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;AGGREGATES_&quot;+document+&quot;.json&quot;</span>
		);
    }
    

	@Override
	public String getCorpusDocumentPipelineString(String corpus, String document) throws IOException {
<span class="nc" id="L264">    	return getCorpusDocumentString(</span>
    			corpus,
<span class="nc" id="L266">				&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;PIPELINE_&quot;+document+&quot;.json&quot;</span>
    	);
	}

	@Override
	public JsonNode getCorpusDocumentPipelineJson(String corpus, String document) throws IOException {
<span class="nc" id="L272">    	return getCorpusDocumentJson(</span>
				corpus,
<span class="nc" id="L274">				&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;PIPELINE_&quot;+document+&quot;.json&quot;</span>
		);
	}

	@Override
	public String getCorpusDocumentStanfordString(String corpus, String document) throws IOException {
<span class="nc" id="L280">    	return getCorpusDocumentString(</span>
				corpus,
<span class="nc" id="L282">				&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;STANFORD_&quot;+document+&quot;.json&quot;</span>
		);
	}

	@Override
	public JsonNode getCorpusDocumentStanfordJson(String corpus, String document) throws IOException {
<span class="nc" id="L288">    	return getCorpusDocumentJson(</span>
				corpus,
<span class="nc" id="L290">				&quot;Analyze&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;STANFORD_&quot;+document+&quot;.json&quot;</span>
		);
	}
	
	@Override
    public ObjectNode getCorpusDocumentOOPMetadata(String corpus, String document) throws IOException {
<span class="nc" id="L296">		return corpusDocumentMetadata.get(corpus).get(document);</span>
	}
	
	@Override
    public String getCorpusDocumentTfidfString(String corpus, String document) throws IOException {
<span class="nc" id="L301">    	return getCorpusDocumentString(</span>
    			corpus, 
<span class="nc" id="L303">				&quot;CoreNLPTfidf&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;TfidfScores_&quot;+document+&quot;.json&quot;</span>
		);
	}
    
	@Override
    public JsonNode getCorpusDocumentTfidfJson(String corpus, String document) throws IOException {
<span class="nc" id="L309">    	return getCorpusDocumentJson(</span>
    			corpus, 
<span class="nc" id="L311">				&quot;CoreNLPTfidf&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;TfidfScores_&quot;+document+&quot;.json&quot;</span>
		);
	}

	@Override
    public String getCorpusDocumentZString(String corpus, String document) throws IOException {
<span class="nc" id="L317">    	return getCorpusDocumentString(</span>
    			corpus, 
<span class="nc" id="L319">				&quot;CoreNLPZ&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;ZScores_&quot;+document+&quot;.json&quot;</span>
		);
	}
	
	@Override
    public JsonNode getCorpusDocumentZJson(String corpus, String document) throws IOException {
<span class="nc" id="L325">    	return getCorpusDocumentJson(</span>
    			corpus, 
<span class="nc" id="L327">				&quot;CoreNLPZ&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;ZScores_&quot;+document+&quot;.json&quot;);</span>
	}
	
	@Override
    public String getCorpusAggregatesMBString(String corpus) throws IOException {
<span class="nc" id="L332">    	return getCorpusDocumentString(</span>
    			corpus,
<span class="nc" id="L334">				&quot;CorpusAggregate&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;CORPUS_AGGREGATES_MB.json&quot;</span>
    	);
    }
    
	@Override
    public JsonNode getCorpusAggregatesMBJson(String corpus) throws IOException {
<span class="nc" id="L340">    	return getCorpusDocumentJson(</span>
    			corpus,
<span class="nc" id="L342">				&quot;CorpusAggregate&quot; + System.getProperty(&quot;file.separator&quot;, &quot;/&quot;) + &quot;CORPUS_AGGREGATES_MB.json&quot;</span>
    	);
    }
	
	
	@Override
    public JsonNode getCorpusTopicModelLemma(String corpus, String lemma) throws IOException {
<span class="nc" id="L349">		ArrayNode retval = getMapper().createArrayNode();</span>
		try {
<span class="nc" id="L351">			Word2Vec vec = WordVectorSerializer.readWord2VecModel(</span>
<span class="nc" id="L352">					getCorpusFilePath(corpus, &quot;CorpusWord2Vec/CORPUS_AGGREGATES_WORD2VEC_Lemmas.word2vec&quot;)</span>
			);
			
<span class="nc bnc" id="L355" title="All 2 branches missed.">			for (String similarWord : vec.wordsNearest(lemma, 25)) {</span>
<span class="nc" id="L356">				double cosSim = vec.similarity(lemma, similarWord);</span>
<span class="nc" id="L357">				ObjectNode tidy = getMapper().createObjectNode();</span>
<span class="nc" id="L358">				tidy.put(&quot;name&quot;, similarWord);</span>
<span class="nc" id="L359">				tidy.put(&quot;value&quot;, cosSim);</span>
<span class="nc" id="L360">				retval.add(tidy);</span>
<span class="nc" id="L361">			}</span>
		}
<span class="nc" id="L363">		catch (Exception e) {</span>
<span class="nc" id="L364">			e.printStackTrace();</span>
<span class="nc" id="L365">		}</span>
		
<span class="nc" id="L367">		return retval;</span>
    }
    
    
	@Override
    public JsonNode getCorpusTopicModelLemmaPOS(String corpus, String lemma) throws IOException {
<span class="nc" id="L373">		ObjectNode retval = getMapper().createObjectNode();</span>
		try {
<span class="nc" id="L375">			Word2Vec vec = WordVectorSerializer.readWord2VecModel(</span>
<span class="nc" id="L376">					getCorpusFilePath(corpus, &quot;CorpusWord2Vec/CORPUS_AGGREGATES_WORD2VEC_Lemmas_POS.word2vec&quot;)</span>
			);
<span class="nc bnc" id="L378" title="All 2 branches missed.">			for (VocabWord vocabWord : vec.getVocab().vocabWords()) {</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">				if (vocabWord.getWord().startsWith(lemma)) {</span>
<span class="nc" id="L380">					ArrayNode similarity = retval.putArray(vocabWord.getWord());</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">					for (String similarWord : vec.wordsNearest(vocabWord.getWord(), 25)) {</span>
<span class="nc" id="L382">						double cosSim = vec.similarity(vocabWord.getWord(), similarWord);</span>
<span class="nc" id="L383">						ObjectNode tidy = getMapper().createObjectNode();</span>
<span class="nc" id="L384">						tidy.put(&quot;name&quot;, similarWord);</span>
<span class="nc" id="L385">						tidy.put(&quot;value&quot;, cosSim);</span>
<span class="nc" id="L386">						similarity.add(tidy);</span>
<span class="nc" id="L387">					}</span>
				}
<span class="nc" id="L389">			}</span>
		}
<span class="nc" id="L391">		catch (Exception e) {</span>
<span class="nc" id="L392">			e.printStackTrace();</span>
<span class="nc" id="L393">		}</span>
<span class="nc" id="L394">		return retval;</span>
    }
	
	@Override
    public JsonNode getCorpusDocumentTopicModelLemma(String corpus, String document, String lemma) throws IOException {
<span class="nc" id="L399">		ArrayNode retval = getMapper().createArrayNode();</span>
		try {
<span class="nc" id="L401">			Word2Vec vec = WordVectorSerializer.readWord2VecModel(</span>
<span class="nc" id="L402">					getCorpusFilePath(corpus, &quot;DocumentWord2Vec/Lemmas_&quot;+document+&quot;.word2vec&quot;)</span>
			);
			
<span class="nc bnc" id="L405" title="All 2 branches missed.">			for (String similarWord : vec.wordsNearest(lemma, 25)) {</span>
<span class="nc" id="L406">				double cosSim = vec.similarity(lemma, similarWord);</span>
<span class="nc" id="L407">				ObjectNode tidy = getMapper().createObjectNode();</span>
<span class="nc" id="L408">				tidy.put(&quot;name&quot;, similarWord);</span>
<span class="nc" id="L409">				tidy.put(&quot;value&quot;, cosSim);</span>
<span class="nc" id="L410">				retval.add(tidy);</span>
<span class="nc" id="L411">			}</span>
		}
<span class="nc" id="L413">		catch (Exception e) {</span>
<span class="nc" id="L414">			e.printStackTrace();</span>
<span class="nc" id="L415">		}</span>
		
<span class="nc" id="L417">		return retval;</span>
    }
    
    
	@Override
    public JsonNode getCorpusDocumentTopicModelLemmaPOS(String corpus, String document, String lemma) throws IOException {
<span class="nc" id="L423">		ObjectNode retval = getMapper().createObjectNode();</span>
		try {
<span class="nc" id="L425">			Word2Vec vec = WordVectorSerializer.readWord2VecModel(</span>
<span class="nc" id="L426">					getCorpusFilePath(corpus, &quot;DocumentWord2Vec/Lemmas_POS_&quot;+document+&quot;.word2vec&quot;)</span>
			);
<span class="nc bnc" id="L428" title="All 2 branches missed.">			for (VocabWord vocabWord : vec.getVocab().vocabWords()) {</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">				if (vocabWord.getWord().startsWith(lemma)) {</span>
<span class="nc" id="L430">					ArrayNode similarity = retval.putArray(vocabWord.getWord());</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">					for (String similarWord : vec.wordsNearest(vocabWord.getWord(), 25)) {</span>
<span class="nc" id="L432">						double cosSim = vec.similarity(vocabWord.getWord(), similarWord);</span>
<span class="nc" id="L433">						ObjectNode tidy = getMapper().createObjectNode();</span>
<span class="nc" id="L434">						tidy.put(&quot;name&quot;, similarWord);</span>
<span class="nc" id="L435">						tidy.put(&quot;value&quot;, cosSim);</span>
<span class="nc" id="L436">						similarity.add(tidy);</span>
<span class="nc" id="L437">					}</span>
				}
<span class="nc" id="L439">			}</span>
		}
<span class="nc" id="L441">		catch (Exception e) {</span>
<span class="nc" id="L442">			e.printStackTrace();</span>
<span class="nc" id="L443">		}</span>
<span class="nc" id="L444">		return retval;</span>
    }
	
	private void setAttributeAvg(ObjectNode retval, List&lt;BigDecimal&gt; scores, String annotationName) {
<span class="nc bnc" id="L448" title="All 2 branches missed.">		if (scores.size() &gt; 0) {</span>
<span class="nc" id="L449">			BigDecimal total = new BigDecimal(0);</span>
<span class="nc" id="L450">			BigDecimal count = new BigDecimal(scores.size());</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">			for (BigDecimal score : scores) {</span>
<span class="nc" id="L452">				total = total.add(score);</span>
<span class="nc" id="L453">			}</span>
<span class="nc" id="L454">			((ObjectNode)retval.get(&quot;attributes&quot;)).put(</span>
					annotationName, 
<span class="nc" id="L456">					total.divide(count, 10, RoundingMode.HALF_DOWN)</span>
			);
		}
<span class="nc" id="L459">	}</span>
	
	private void setAttributeListBigDecimal(ObjectNode retval, List&lt;BigDecimal&gt; scores, String annotationName) {
<span class="nc bnc" id="L462" title="All 2 branches missed.">		if (scores.size() &gt; 0) {</span>
<span class="nc" id="L463">			ArrayNode list = ((ObjectNode)retval.get(&quot;lists&quot;)).putArray(annotationName);</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">			for (BigDecimal score : scores) {</span>
<span class="nc" id="L465">				list.add(score);</span>
<span class="nc" id="L466">			}</span>
		}
<span class="nc" id="L468">	}</span>
	
	private void setAttributeListString(ObjectNode retval, List&lt;String&gt; scores, String annotationName) {
<span class="nc bnc" id="L471" title="All 2 branches missed.">		if (scores.size() &gt; 0) {</span>
<span class="nc" id="L472">			ArrayNode list = ((ObjectNode)retval.get(&quot;lists&quot;)).putArray(annotationName);</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">			for (String score : scores) {</span>
<span class="nc" id="L474">				list.add(score);</span>
<span class="nc" id="L475">			}</span>
		}
<span class="nc" id="L477">	}</span>
	
	private void setAttributeSubAnnotation(ObjectNode retval, ObjectNode tokenNode, String subAnnotationName) {
<span class="nc" id="L480">		ObjectNode annotationNode = getMapper().createObjectNode();</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">		if (tokenNode.has(subAnnotationName)) {</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">			if (retval.get(&quot;attributes&quot;).has(subAnnotationName)) {</span>
<span class="nc" id="L483">				annotationNode = (ObjectNode) retval.get(&quot;attributes&quot;).get(subAnnotationName);</span>
			}
			else {
<span class="nc" id="L486">				annotationNode = ((ObjectNode)retval.get(&quot;attributes&quot;)).putObject(subAnnotationName);</span>
			}
<span class="nc" id="L488">			BigDecimal val = new BigDecimal(1);</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">			if (annotationNode.has(tokenNode.get(subAnnotationName).asText())) {</span>
<span class="nc" id="L490">				val = new BigDecimal(annotationNode.get(tokenNode.get(subAnnotationName).asText()).asText()).add(val);</span>
			}
<span class="nc" id="L492">			annotationNode.put(tokenNode.get(subAnnotationName).asText(), val);</span>
		}
<span class="nc" id="L494">	}</span>
	
	private void setAttributeAnnotation(ObjectNode retval, ObjectNode tokenNode, String annotation) {
<span class="nc" id="L497">		ObjectNode annotationNode = getMapper().createObjectNode();</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">		if (tokenNode.has(annotation)) {</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">			if (tokenNode.get(annotation).isObject()) {</span>
<span class="nc" id="L500">				Iterator&lt;String&gt; fieldNameIter = ((ObjectNode)tokenNode.get(annotation)).fieldNames();</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">				while (fieldNameIter.hasNext()) {</span>
<span class="nc" id="L502">					String subAnnotationName = fieldNameIter.next();</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">					if (tokenNode.get(annotation).has(subAnnotationName)) {</span>
<span class="nc" id="L504">						BigDecimal val = new BigDecimal(tokenNode.get(annotation).get(subAnnotationName).asText());</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">						if (retval.get(&quot;attributes&quot;).has(annotation)) {</span>
<span class="nc" id="L506">							annotationNode = (ObjectNode) retval.get(&quot;attributes&quot;).get(annotation);</span>
						}
						else {
<span class="nc" id="L509">							annotationNode = ((ObjectNode)retval.get(&quot;attributes&quot;)).putObject(annotation);</span>
						}
<span class="nc bnc" id="L511" title="All 2 branches missed.">						if (annotationNode.has(subAnnotationName)) {</span>
<span class="nc" id="L512">							val = new BigDecimal(annotationNode.get(subAnnotationName).asText()).add(val);</span>
						}
<span class="nc" id="L514">						annotationNode.put(subAnnotationName, val);</span>
					}
<span class="nc" id="L516">				}</span>
<span class="nc" id="L517">			}</span>
			else {
<span class="nc" id="L519">				System.out.println(annotation);</span>
			}
		}
<span class="nc" id="L522">	}</span>
	
	private void setAttributeList(ObjectNode retval, ObjectNode tokenNode, String annotation) {
<span class="nc" id="L525">		ArrayNode annotationNode = getMapper().createArrayNode();</span>

<span class="nc bnc" id="L527" title="All 2 branches missed.">		if (tokenNode.has(annotation)) {</span>
<span class="nc bnc" id="L528" title="All 2 branches missed.">			if (retval.get(&quot;attributes&quot;).has(annotation)) {</span>
<span class="nc" id="L529">				annotationNode = (ArrayNode) retval.get(&quot;attributes&quot;).get(annotation);</span>
			}
			else {
<span class="nc" id="L532">				annotationNode = ((ObjectNode)retval.get(&quot;attributes&quot;)).putArray(annotation);</span>
			}
<span class="nc" id="L534">			boolean annotationInList = false;</span>
<span class="nc" id="L535">			Iterator&lt;JsonNode&gt; attributeListIter = annotationNode.iterator();</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">			while (attributeListIter.hasNext()) {</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">				if (attributeListIter.next().asText().equals(tokenNode.get(annotation).asText())) {</span>
<span class="nc" id="L538">					annotationInList = true;</span>
<span class="nc" id="L539">					break;</span>
				}
			}
<span class="nc bnc" id="L542" title="All 2 branches missed.">			if (!annotationInList) {</span>
<span class="nc" id="L543">				annotationNode.add(tokenNode.get(annotation).asText());</span>
			}
		}
<span class="nc" id="L546">	}</span>
	
	@Override
    public JsonNode getCorpusDocumentLexiconLemma(String corpus, String document, String lemma) throws IOException {
<span class="nc" id="L550">		ObjectNode retval = null;</span>
<span class="nc" id="L551">		List&lt;BigDecimal&gt; oopSyllableCountAnnotations = new ArrayList&lt;BigDecimal&gt;();</span>
<span class="nc" id="L552">		List&lt;BigDecimal&gt; vaderSentimentAnnotations = new ArrayList&lt;BigDecimal&gt;();</span>
<span class="nc" id="L553">		List&lt;BigDecimal&gt; coreNlpSentimentAnnotations = new ArrayList&lt;BigDecimal&gt;();</span>
<span class="nc" id="L554">		List&lt;BigDecimal&gt; oopWordCountAnnotations = new ArrayList&lt;BigDecimal&gt;();</span>
<span class="nc" id="L555">		List&lt;BigDecimal&gt; oopFleschKinkaidAnnotations = new ArrayList&lt;BigDecimal&gt;();</span>
<span class="nc" id="L556">		List&lt;BigDecimal&gt; paragraphIndexAnnotations = new ArrayList&lt;BigDecimal&gt;();</span>
<span class="nc" id="L557">		List&lt;BigDecimal&gt; sentenceIndexAnnotations = new ArrayList&lt;BigDecimal&gt;();</span>
<span class="nc" id="L558">		List&lt;String&gt; sentenceTextAnnotations = new ArrayList&lt;String&gt;();	</span>
<span class="nc" id="L559">		JsonNode scores = getCorpusDocumentOOPJson(corpus, document);</span>
<span class="nc" id="L560">		Iterator&lt;JsonNode&gt; sentenceIterator = scores.get(&quot;sentences&quot;).elements();</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">		for (int sentenceIdx=0;sentenceIterator.hasNext();sentenceIdx++) {</span>
<span class="nc" id="L562">			JsonNode sentenceNode = sentenceIterator.next();</span>
<span class="nc" id="L563">			Iterator&lt;JsonNode&gt; tokenIterator = sentenceNode.get(&quot;tokens&quot;).elements();</span>
<span class="nc" id="L564">			boolean lemmaInSentence = false;</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">			while (tokenIterator.hasNext()) {</span>
<span class="nc" id="L566">				ObjectNode tokenNode = (ObjectNode) tokenIterator.next();</span>
<span class="nc" id="L567">				ObjectNode tokensAnnotation = (ObjectNode) tokenNode.get(&quot;TokensAnnotation&quot;);</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">				if (tokensAnnotation.get(&quot;lemma&quot;).asText().equals(lemma)) {</span>
<span class="nc" id="L569">					lemmaInSentence = true;</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">					if (retval == null) {</span>
<span class="nc" id="L571">						retval = getMapper().createObjectNode();</span>
<span class="nc" id="L572">						retval.put(&quot;canonicalName&quot;, lemma);</span>
<span class="nc" id="L573">						retval.put(&quot;firstAppearance&quot;, sentenceIdx);</span>
<span class="nc" id="L574">						retval.put(&quot;lastAppearance&quot;, sentenceIdx);</span>
<span class="nc" id="L575">						retval.put(&quot;importance&quot;, new BigDecimal(0));</span>
<span class="nc" id="L576">						retval.putObject(&quot;attributes&quot;);</span>
<span class="nc" id="L577">						retval.putObject(&quot;lists&quot;);</span>
					}
<span class="nc" id="L579">					retval.put(&quot;lastAppearance&quot;, sentenceIdx);</span>
<span class="nc" id="L580">					retval.put(&quot;importance&quot;, retval.get(&quot;importance&quot;).asInt()+1);</span>
					//attributes
<span class="nc" id="L582">					setAttributeSubAnnotation(retval, tokensAnnotation, &quot;word&quot;);</span>
<span class="nc" id="L583">					setAttributeSubAnnotation(retval, tokensAnnotation, &quot;pos&quot;);</span>
<span class="nc" id="L584">					setAttributeSubAnnotation(retval, tokensAnnotation, &quot;ner&quot;);</span>
					
<span class="nc" id="L586">					setAttributeAnnotation(retval, tokenNode, &quot;CoreNlpGenderAnnotation&quot;);</span>
<span class="nc" id="L587">					setAttributeAnnotation(retval, tokenNode, &quot;OOPAmericanizeAnnotation&quot;);</span>
<span class="nc" id="L588">					setAttributeAnnotation(retval, tokenNode, &quot;OOPAngliciseAnnotation&quot;);</span>
<span class="nc" id="L589">					setAttributeAnnotation(retval, tokenNode, &quot;OOPBiberAnnotation&quot;);</span>
<span class="nc" id="L590">					setAttributeAnnotation(retval, tokenNode, &quot;OOPBiberDimensionsAnnotation&quot;);</span>
<span class="nc" id="L591">					setAttributeAnnotation(retval, tokenNode, &quot;OOPColorsAnnotation&quot;);</span>
<span class="nc" id="L592">					setAttributeAnnotation(retval, tokenNode, &quot;OOPCommonWordsAnnotation&quot;);</span>
<span class="nc" id="L593">					setAttributeAnnotation(retval, tokenNode, &quot;OOPFlavorsAnnotation&quot;);</span>
<span class="nc" id="L594">					setAttributeAnnotation(retval, tokenNode, &quot;OOPFunctionWordsAnnotation&quot;);</span>
<span class="nc" id="L595">					setAttributeAnnotation(retval, tokenNode, &quot;OOPGenderAnnotation&quot;);</span>
<span class="nc" id="L596">					setAttributeAnnotation(retval, tokenNode, &quot;OOPNonAffirmativeAnnotation&quot;);</span>
<span class="nc" id="L597">					setAttributeAnnotation(retval, tokenNode, &quot;OOPNounGroupsAnnotation&quot;);</span>
<span class="nc" id="L598">					setAttributeAnnotation(retval, tokenNode, &quot;OOPNounNypernymsAnnotation&quot;);</span>
<span class="nc" id="L599">					setAttributeAnnotation(retval, tokenNode, &quot;OOPPointlessAdjectivesAnnotation&quot;);</span>
<span class="nc" id="L600">					setAttributeAnnotation(retval, tokenNode, &quot;OOPPointlessAdverbsAnnotation&quot;);</span>
<span class="nc" id="L601">					setAttributeAnnotation(retval, tokenNode, &quot;OOPSVOAnnotation&quot;);</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">					if (tokenNode.has(&quot;OOPSyllableCountAnnotation&quot;)) {</span>
<span class="nc" id="L603">						oopSyllableCountAnnotations.add(new BigDecimal(tokenNode.get(&quot;OOPSyllableCountAnnotation&quot;).asText()));</span>
					}
<span class="nc" id="L605">					setAttributeAnnotation(retval, tokenNode, &quot;OOPTemporalNGramsAnnotation&quot;);</span>
<span class="nc" id="L606">					setAttributeAnnotation(retval, tokenNode, &quot;OOPUncommonWordsAnnotation&quot;);</span>
<span class="nc" id="L607">					setAttributeAnnotation(retval, tokenNode, &quot;OOPVerbGroupsAnnotation&quot;);</span>
<span class="nc" id="L608">					setAttributeAnnotation(retval, tokenNode, &quot;OOPVerbHypernymsAnnotation&quot;);</span>
<span class="nc" id="L609">					setAttributeAnnotation(retval, tokenNode, &quot;OOPVerbnetGroupsAnnotation&quot;);</span>
<span class="nc" id="L610">					setAttributeAnnotation(retval, tokenNode, &quot;OOPWordlessWordsAnnotation&quot;);</span>
					
<span class="nc" id="L612">					setAttributeList(retval, tokenNode, &quot;OOPWikipediaGlossAnnotation&quot;);</span>
<span class="nc" id="L613">					setAttributeList(retval, tokenNode, &quot;OOPWordnetGlossAnnotation&quot;);</span>
				}	
<span class="nc" id="L615">			}</span>
<span class="nc bnc" id="L616" title="All 2 branches missed.">			if (lemmaInSentence) {</span>
<span class="nc bnc" id="L617" title="All 2 branches missed.">				if (sentenceNode.has(&quot;VaderSentimentAnnotation&quot;)) {</span>
<span class="nc" id="L618">					vaderSentimentAnnotations.add(new BigDecimal(sentenceNode.get(&quot;VaderSentimentAnnotation&quot;).asText()));</span>
				}
<span class="nc bnc" id="L620" title="All 2 branches missed.">				if (sentenceNode.has(&quot;CoreNlpSentimentAnnotation&quot;)) {</span>
<span class="nc" id="L621">					coreNlpSentimentAnnotations.add(new BigDecimal(sentenceNode.get(&quot;CoreNlpSentimentAnnotation&quot;).asText()));</span>
				}
<span class="nc bnc" id="L623" title="All 2 branches missed.">				if (sentenceNode.has(&quot;OOPWordCountAnnotation&quot;)) {</span>
<span class="nc" id="L624">					oopWordCountAnnotations.add(new BigDecimal(sentenceNode.get(&quot;OOPWordCountAnnotation&quot;).asText()));</span>
				}
<span class="nc bnc" id="L626" title="All 2 branches missed.">				if (sentenceNode.has(&quot;OOPFleschKinkaidAnnotation&quot;)) {</span>
<span class="nc" id="L627">					oopFleschKinkaidAnnotations.add(new BigDecimal(sentenceNode.get(&quot;OOPFleschKinkaidAnnotation&quot;).asText()));</span>
				}
<span class="nc bnc" id="L629" title="All 2 branches missed.">				if (sentenceNode.has(&quot;text&quot;)) {</span>
<span class="nc" id="L630">					sentenceTextAnnotations.add(sentenceNode.get(&quot;text&quot;).asText());</span>
				}
<span class="nc bnc" id="L632" title="All 2 branches missed.">				if (sentenceNode.has(&quot;SentenceIndexAnnotation&quot;)) {</span>
<span class="nc" id="L633">					sentenceIndexAnnotations.add(new BigDecimal(sentenceNode.get(&quot;SentenceIndexAnnotation&quot;).asText()));</span>
				}
<span class="nc bnc" id="L635" title="All 2 branches missed.">				if (sentenceNode.has(&quot;ParagraphIndexAnnotation&quot;)) {</span>
<span class="nc" id="L636">					paragraphIndexAnnotations.add(new BigDecimal(sentenceNode.get(&quot;ParagraphIndexAnnotation&quot;).asText()));</span>
				}				
<span class="nc bnc" id="L638" title="All 2 branches missed.">				if (sentenceNode.has(&quot;OOPPunctuationMarkAnnotation&quot;)) {</span>
<span class="nc" id="L639">					setAttributeAnnotation(retval, (ObjectNode)sentenceNode, &quot;OOPPunctuationMarkAnnotation&quot;);</span>
				}
			}
		}
<span class="nc" id="L643">		setAttributeAvg(retval, oopSyllableCountAnnotations, &quot;OOPSyllableCountAnnotation&quot;);</span>
<span class="nc" id="L644">		setAttributeAvg(retval, vaderSentimentAnnotations, &quot;VaderSentimentAnnotation&quot;);</span>
<span class="nc" id="L645">		setAttributeAvg(retval, coreNlpSentimentAnnotations, &quot;CoreNlpSentimentAnnotation&quot;);</span>
<span class="nc" id="L646">		setAttributeAvg(retval, oopWordCountAnnotations, &quot;OOPWordCountAnnotation&quot;);</span>
<span class="nc" id="L647">		setAttributeAvg(retval, oopFleschKinkaidAnnotations, &quot;OOPFleschKinkaidAnnotation&quot;);</span>
<span class="nc" id="L648">		setAttributeListBigDecimal(retval, paragraphIndexAnnotations, &quot;ParagraphIndexAnnotation&quot;);</span>
<span class="nc" id="L649">		setAttributeListBigDecimal(retval, sentenceIndexAnnotations, &quot;SentenceIndexAnnotation&quot;);</span>
<span class="nc" id="L650">		setAttributeListString(retval, sentenceTextAnnotations, &quot;SentenceTextAnnotation&quot;);		</span>
		
<span class="nc" id="L652">		return retval;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>